'use strict';

var _=window._;

var AppRouter = window.Backbone.Router.extend({
	routes: {
		'': 'root',
		'blog(/)(/:post)': 'blog',
		'projects(/:project)': 'projects',
		'contact': 'contact',
		'about': 'about'
	},

	initialize: function(context){

		this.listenTo(window.Backbone, 'router:redirect', this.redirect);
		this.listenTo(window.Backbone, 'router:goToCurrentContent', this.goToCurrentContent);
		this.listenTo(window.Backbone, 'router:nextContent', this.goToNextContent);
		this.listenTo(window.Backbone, 'router:prevContent', this.goToPrevContent);

		this.currentContentRoute = this.defaultContentRoute();
		
		this.on('route:root' ,function(){

  		new context.views.intro({
  			model: {},
  			template: context.templates.intro
  		});
  		$('body').addClass('intro');
  		
		});

		this.on('route:blog' ,function(slug){

			// var options = (arguments[1] || {});

			if (!context.views.blog.initialized) {
				context.views.blog = new context.views.blog({
	  			slug: slug,
	  			el: context.mainPanel,
	  			template: context.templates['blog-post']
	  		});
			}

			var transition = (this.currentContentView === context.views.blog);

			if (!slug) {
				slug = context.views.blog.defaultSlug();
				this.navigate(context.views.blog.defaultRoute());
  			context.views.blog.render({slug: slug});
  		} else {
  			if (context.views.blog.checkSlug(slug)) {
  				context.views.blog.render({slug: slug, transition: transition});
  			} else {
  				context.views.blog.render({transition: transition});
  			}
  		}

			this.currentContentRoute = window.Backbone.history.fragment;
			this.currentContentView = context.views.blog;
			
		});

		this.on('route:projects' ,function(slug){

			if (!context.views.projects.initialized) {
				context.views.projects = new context.views.projects({
	  			slug: slug,
	  			el: context.mainPanel,
	  			template: context.templates.project
	  		});
			}

			var transition = (this.currentContentView === context.views.projects);

			if (!slug) {

				slug = context.views.projects.defaultSlug();
				this.navigate(context.views.projects.defaultRoute());
  			context.views.projects.render({slug: slug});
  		} else {
  			if (context.views.projects.checkSlug(slug)) {
  				context.views.projects.render({slug: slug, transition: transition});
  			} else {
  				context.views.projects.render({transition: transition});
  			}
  		}

  		this.currentContentRoute = window.Backbone.history.fragment;
  		this.currentContentView = context.views.projects;
  		
		});

		this.on('route:contact' ,function(){
			if (!context.views.contact.initialized) {
				context.views.contact = new context.views.contact({
	  			model: {},
	  			el: context.mainPanel,
	  			template: context.templates.contact
	  		});
			}

  		context.views.contact.render();
  		this.currentContentRoute = window.Backbone.history.fragment;
  		this.currentContentView = context.views.contact;
  		
		});

		this.on('route:about' ,function(){
			if (!context.views.about.initialized) {
				context.views.about = new context.views.about({
	  			model: {},
	  			el: context.mainPanel,
	  			template: context.templates.about
	  		});
			}

  		context.views.about.render();
  		this.currentContentRoute = window.Backbone.history.fragment;
  		this.currentContentView = context.views.about;
  		
		});

		this.on('route:defaultRoute', function(){
		});

		window.Backbone.history.start();

	},
	goToCurrentContent: function () {
		this.navigate(this.currentContentRoute);
	},
	goToPrevContent: function () {
		console.log('goToPrevContent');
		if (!_.isFunction(this.currentContentView.getPrevModel)) { return false; }
		// var route = this.currentContentView.namespace;
		var route = this.currentContentView.prevRoute();
		console.log('route', route);
		// var slug = this.currentContentView.getPrevModel().get('slug');
		// this.trigger('route:' + route, slug, {transition: 'prev'});
		this.navigate(route);

		// return {slug: slug, route: 'route:'+ route, v: this.currentContentView};
	},
	goToNextContent: function () {
		if (!_.isFunction(this.currentContentView.getNextModel)) { return false; }
		// var route = this.currentContentView.namespace;
		var route = this.currentContentView.nextRoute();
		// var slug = this.currentContentView.getNextModel().get('slug');
		// this.trigger('route:' + route, slug, {transition: 'next'});
		// console.log(route);
		this.navigate(route);

		// return {slug: slug, route: 'route:'+ route, v: this.currentContentView};
	},
	defaultContentRoute: function () {
		return '#/about';
	},
	redirect: function(route){
		this.navigate(route);
	}

});

module.exports = AppRouter;